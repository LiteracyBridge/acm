<!-- This file installs ivy and loads it, giving ant access to the ivy:task namespace -->

<project xmlns:ivy="antlib:org.apache.ivy.ant">

  <property file="${root.dir}/ant/build.properties"/>
  <property name="projects.dir" value="${root.dir}/projects" />

  <property name="ivy.install.version" value="2.2.0" />
  <property name="ivy.jar.dir" value="${user.home}/.ivy2" />
  <property name="ivy.jar.file" value="${ivy.jar.dir}/ivy-${ivy.install.version}.jar" />
  <property name="ivy.repo.cache.dir" value="${ivy.jar.dir}/repository_cache"/>

  <!-- These are necessary to push to the twitter maven repo via SVN -->
  <property name="ivysvnresolver.install.version" value="2.2.0" />
  <property name="ivysvnresolver.tar.file" value="${ivy.jar.dir}/ivysvnresolver-${ivysvnresolver.install.version}.tgz" />

  <property name="artifactory.host" value="artifactory.local.twitter.com"/>

  <target name="update-ivy">
    <sequential>
      <available file="${ivy.jar.file}" property="skip.download" />
      <antcall target="download-ivy" />
    </sequential>
  </target>

  <!-- Download ivy -->
  <target name="download-ivy" unless="skip.download">
    <mkdir dir="${ivy.jar.dir}"/>
    <condition property="ivy.url" value="file:${ivy.jar.file}">
      <available file="${ivy.jar.file}" />
    </condition>
    <property name="ivy.url" value="http://${artifactory.host}/repo/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar" />
    <get src="${ivy.url}" dest="${ivy.jar.file}.download" usetimestamp="true" />
    <move file="${ivy.jar.file}.download" tofile="${ivy.jar.file}" />

    <condition property="ivysvnresolver.url" value="file:${ivysvnresolver.tar.file}">
      <available file="${ivysvnresolver.tar.file}" />
    </condition>
    <property name="ivysvnresolver.url" value="http://${artifactory.host}/repo/ivysvnresolver/ivysvnresolver/${ivysvnresolver.install.version}/ivysvnresolver-${ivysvnresolver.install.version}-bin.tgz" />
    <get src="${ivysvnresolver.url}" dest="${ivysvnresolver.tar.file}.download" usetimestamp="true" />
    <move file="${ivysvnresolver.tar.file}.download" tofile="${ivysvnresolver.tar.file}" />
    <untar compression="gzip" src="${ivysvnresolver.tar.file}" dest="${ivy.jar.dir}">
      <patternset>
          <include name="ivysvnresolver-${ivysvnresolver.install.version}/lib/trilead.jar"/>
          <include name="ivysvnresolver-${ivysvnresolver.install.version}/lib/svnkit.jar"/>
          <include name="ivysvnresolver-${ivysvnresolver.install.version}/ivysvnresolver.jar"/>
      </patternset>
      <mapper type="flatten"/>
    </untar>
  </target>

  <!-- Import ivy's ant tasks -->
  <target name="install-ivy" depends="update-ivy">
    <path id="ivy.lib.path">
      <fileset dir="${ivy.jar.dir}" includes="ivy-${ivy.install.version}.jar jsch-${jsch.install.version}.jar"/>
    </path>
    <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path" />
    <ivy:settings file="${root.dir}/ant/ivysettings.xml" />
  </target>

  <!-- Define filename-friendly names for the OS variants for importing native libs -->
  <condition property="os.libsname" value="osx">
    <os name="Mac OS X" />
  </condition>
  <condition property="os.libsname" value="linux">
    <os name="Linux" />
  </condition>

</project>
